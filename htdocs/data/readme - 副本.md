##KISP 框架
---------------------------------------------------------------
###[接口文档 3.0.0](?type=default&version=3.0.0)

### KISP 简介 

> KISP 是一个轻量级的 JavaScript 框架，采用 CMD 模式进行模块化的封装，提供了一些模块和接口，可以用于开发 Web 轻应用。

##主要功能

###KISP公共模块的使用
要使用 KISP 框架的公开的模块，统一使用` KISP.require('id')` 的方式。
``` javascript
	var WeChat = KISP.require('WeChat');
```

###模块的定义与加载
提供了 CMD 模块的定义与加载接口，业务层可以很方便的定义一个 CMD 模块，并在其它模块加载它。如：

``` javascript

/**
* 定义一个公共模块: User
*/
define('User', function (require, module, exports) {
    
    //相当于 require('User/Login');
    //加载当前模块的直接子模块，只能用短名称方式
    var Login = require(module, 'Login'); 

});


/**
* 定义一个私有模块: Login，使它属于 User 的子模块。
*/
define('User/Login', function (require, module, exports) {

    return {
        //要暴露的接口和字段
    };

});
```
####模块的层级关系
我们推荐使用具有树形层级关系的模块系统，这样带来的好处是，模块与模块之间的依赖不再是一个复杂的网状结构，而是一个具有上下级关系的树形结构，从而使模块之间的关系更简单，依赖和管理也更可控。

树形结构的模块系统
我们使用具名的模块定义方式，即在定义模块时，`第一个参数`(字符串)即为模块的`名称`(`id`)。模块名称中，我们使用熟悉的`路径系统`的表示方式来表示出模块之间的父子关系，具体举例：

`User`

`User/Login`

`User/Login/API`

`User/Login/Loading`

`User/List`

`User/List/Scroller`

`User/List/Template`

从层级上可以看出，
`User` 模块的直接子模块：`Login` 和 `List`

`Login`模块的直接子模块：`API`和`Loading`

`List`模块的直接子模块：`Scroller`和`Template`

从 JSON 的角度来看，它们更像：

``` json
{
    "User": {
        "Login": [
	        "API", 
	        "Loading"
        ],
        "List": [
	        "Scoller", 
	        "Template"
        ],
    }
}
```

通过这种路径的表示方式，我们可以构造出一棵模块树。在上面的例子中，树的根节点是 `User`。

###模块树下的模块加载约束
我们建造这棵模块树的初衷：把模块之间的复杂的网状关系变成具有上下级关系的树形结构。在框架上，我们也做了强约束，模块与模块之间的加载与可见性要遵守一定的约束，总的来说：**一个模块只能加载对它可见的模块**。具体为：
- 兄弟模块之间互相不可见，从而互相不能加载对方，就如同它们互相不知道对方的存在一样，从而保证模块的独立性。
- 子模块仅对直接父模块可见，从而 **有且仅有** 直接父模块可以加载它们。换言之，一个模块只能加载自己的直接子模块，连孙子模块也不能加载。
- 当一个模块开始变得复杂时，可采用递归和分而治之的方式进一步划分成父模块和直接子模块。

对于上面的例子：在 `User` 模块里，要加载其子模块 `Login`，只能用短名称的方式，并且把当前模块对象传进去：
``` javascript
require(module, 'Login'); //短名称方式：正确的方式
``` 
而不能用长名称方式
``` javascript
require('User/Login'); //长名称方式：会抛出异常
``` 
因为长名称方式无法检测一个模块与被加载模块之间的直接父子关系，从而无法确保上述的强约束。


**注意**：私有模块以 `/` 开头，公共模块则不需要。
**原则**：优先使用私有模块，尽量减少公共模块的定义和使用。因为公共模块会给很多别的模块引用，对公共模块的改动将会对依赖于它的其它模块产生很大影响，从而带来维护上的困难。使用私有模块则不会有该问题。

###后台数据请求
在金蝶 KIS 业务中，后台数据的来源一般分为两种：
- 云服务器
- SSH 服务器

云服务器的情况最简单，直接请求给定 Url 的服务器即可拿到业务数据。
SSH 服务器的稍微复杂点，需要先请求一台中转服务器，以拿到一些必需的信息，这里称为中转信息，再以这些信息去请求真实的服务器方可拿到业务数据。当然，仅第一次请求时需要去中转服务器获取中转信息，然后缓存起来，在后续的请求中，可以复用缓存的中转信息，直接请求真实的服务器。

后台服务器要在响应头里对请求 Host 开放，并且返回指定格式的 JSON 数据，否则 KISP 框架无法正确获取并处理。
在满足要求的数据格式前提下，为了应对不同业务的数据字段名不同的问题，业务开发者需要给定配置以映射字段。
对于云服务器，一个完整的、理想的后台数据应该如下：

```json
{
      "code": 200,
      "msg": "ok",
      "data": {
          
      }
}
```

字段含义：

名称 | 类型 | 作用 
------ | ---- | ---- 
`code` | `string` 或 `number` | 状态码，用于表示业务处理的状态，是成功还是失败。成功码只有一个，其它的均表示失败。
`msg` | `string` | 描述消息。用于描述状态，尤其在失败时，给出失败的原因描述，帮助前端开发者快速理解失败的原因。
`data` | `Object` | 业务的主体数据。业务所有的数据均可包装在该字段里，格式可以自定义。

以上三个字段是标准的字段，当后台返回的字段名跟标准字段不一样时，业务开发者需要配置字段映射关系。假如某业务后台返回的数据格式如下：

```json
{
      "Result": 200,
      "ErrMsg": "ok",
      "Data": {
          
      }
}
```
为了让 KISP 能正确理解该数据，需要配置：

``` javascript
KISP.config({
    'API': {
        field: {
            code: 'Result',
            msg: 'ErrMsg',
            data: 'Data',
        },
    },
});
```

在 KISP 里，默认的成功码是 `200`，如果业务中要用别的状态码表示成功，则需要配置：

``` javascript
KISP.config({
    'API': {
	    successCode: 0, //假设成功码为 0，其它的均表示失败
    },
});

```

KISP 中的 API 模块的默认配置：
``` javascript
KISP.config({
    /**
    * API 模块的默认配置
    */
    'API': {
        successCode: 200,
        field: {
            code: 'code',
            msg: 'msg',
            data: 'data',
        },

        /**
        * 随机延迟时间，更真实模块实际网络
        */
        delay: false, //格式为 { min: 500, max: 2000 }

        /**
        * 在 url 中增加一个随机 key，以解决缓存问题。
        */
        random: true,

        /**
        * 把请求时的 data 中的第一级子对象进行序列化的方法。
        * @param {string} key 要进行处理的子对象的键。
        * @param {Object} value 要进行处理的子对象的值对象。
        * @return {string} 返回该子对象序列化的字符串。
        */
        serialize: function (key, value) {
            var $ = require('$');
            var json = $.Object.toJson(value);
            return encodeURIComponent(json);
        },
    }
});
``` 

###公共UI组件
###第三方运行环境接口
目前提供了云之家和微信的第三方运行环境接口。
微信的模块为 `WeChat`，包括了微信依赖的 js 库文件的加载、微信签名验证等。

``` javascript
var WeChat = KISP.require('WeChat');

//初始化微信运行环境，包括微信依赖的 js 库文件的加载和微信签名验证。
WeChat.init({
    'appid': 'appid',
    'eid': 'eid',
});

//在成功后会触发 ready 事件
WeChat.on('ready', function (wxObj) {
    //
});
```
###其它一些辅助工具方法